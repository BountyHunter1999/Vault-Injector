name: Test the Vault Injector

on:
    push:
        branches:
            - main
    pull_request:
        branches:
            - main

jobs:
    test:
        runs-on: ubuntu-latest
        env:
            VAULT_ADDR: http://localhost:8200

        steps:
            - uses: actions/checkout@v4

            # - name: Setup Docker Buildx
            #   uses: docker/setup-buildx-action@v3

            - name: Start Vault Service
              run: |
                  mkdir -p ./vault/{config,data}

                  docker compose up -d vault
                  sleep 5

            - name: Install UV
              uses: astral-sh/setup-uv@v6
              with:
                  python-version-file: ".python-version"

            - name: See running containers
              run: |
                  docker ps
                  docker compose logs vault
            - name: Init Vault
              run: |
                  mkdir -p secrets/vault
                  make get-unseal-keys

            - name: Create .env file
              run: |
                  #   export VAULT_TOKEN=$(cat secrets/vault/vault-unseal-keys.txt | grep "Initial Root Token" | awk '{print $4}')
                  echo "VAULT_TOKEN=$(cat secrets/vault/vault-unseal-keys.txt | grep "Initial Root Token" | cut -d ":" -f2 | tr -d ' ')" > tests/.env
                  echo "VAULT_UNSEAL_KEYS=$(grep "Unseal Key" secrets/vault/vault-unseal-keys.txt| awk '{print $4}' | paste -sd "," -)" >> tests/.env

            - name: Install dependencies
              run: |
                  uv sync

            - name: Run tests
              run: |
                  cd tests && uv run pytest
